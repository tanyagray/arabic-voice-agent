# LiveKit Token Server

A FastAPI-based token server for generating LiveKit access tokens.

## Features

- RESTful API endpoint for token generation
- Support for both GET and POST methods
- Configurable participant permissions
- CORS support for web clients
- Environment-based configuration
- Comprehensive API documentation (auto-generated by FastAPI)

## Setup

This project uses [uv](https://docs.astral.sh/uv/) for dependency management and [Task](https://taskfile.dev/) for task automation.

### 1. Install Dependencies

```bash
cd web-api
task install
# or manually: uv sync
```

### 2. Configure Environment Variables

Create a `.env` file based on `.env.example`:

```bash
cp .env.example .env
```

Edit `.env` and add your LiveKit credentials:

```env
LIVEKIT_API_KEY=your_api_key_here
LIVEKIT_API_SECRET=your_api_secret_here
LIVEKIT_URL=wss://your-livekit-server.com
```

### 3. Run the Server

Using Task (recommended):

```bash
task dev     # Development mode with hot reload
task start   # Production mode
```

Or using uv directly:

```bash
uv run uvicorn main:app --reload --host 0.0.0.0 --port 8000
```

The server will start on `http://localhost:8000`

## API Endpoints

### Root Endpoint

```
GET /
```

Returns the service status.

### Health Check

```
GET /health
```

Returns detailed health status including configuration check.

### Generate Token (POST)

```
POST /livekit/token
Content-Type: application/json

{
  "room_name": "my-room",
  "participant_identity": "user123",
  "participant_name": "John Doe",
  "can_publish": true,
  "can_subscribe": true,
  "can_publish_data": true
}
```

**Response:**
```json
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "url": "wss://your-livekit-server.com"
}
```

### Generate Token (GET)

```
GET /livekit/token?room_name=my-room&participant_identity=user123&participant_name=John%20Doe
```

Query parameters:
- `room_name` (required): Name of the LiveKit room
- `participant_identity` (required): Unique identity for the participant
- `participant_name` (optional): Display name
- `can_publish` (optional, default: true): Permission to publish audio/video
- `can_subscribe` (optional, default: true): Permission to subscribe to tracks
- `can_publish_data` (optional, default: true): Permission to publish data messages

## Interactive API Documentation

FastAPI provides automatic interactive documentation:

- Swagger UI: `http://localhost:8000/docs`
- ReDoc: `http://localhost:8000/redoc`

## Security Considerations

1. **CORS Configuration**: Update the `allow_origins` in `main.py` to restrict access to specific domains in production:
   ```python
   allow_origins=["https://your-frontend-domain.com"]
   ```

2. **Environment Variables**: Never commit `.env` files with real credentials to version control.

3. **HTTPS**: Use HTTPS in production. Configure a reverse proxy (nginx, Caddy) or deploy behind a load balancer.

4. **Rate Limiting**: Consider adding rate limiting to prevent abuse of the token endpoint.

5. **Authentication**: Add authentication/authorization to the token endpoint to verify that requesters are authorized users.

## Example Client Usage

### JavaScript/TypeScript

```javascript
async function getToken(roomName, identity, name) {
  const response = await fetch('http://localhost:8000/livekit/token', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      room_name: roomName,
      participant_identity: identity,
      participant_name: name,
    }),
  });

  const data = await response.json();
  return data;
}

// Usage
const { token, url } = await getToken('my-room', 'user123', 'John Doe');
```

### Python

```python
import requests

def get_token(room_name, identity, name):
    response = requests.post(
        'http://localhost:8000/livekit/token',
        json={
            'room_name': room_name,
            'participant_identity': identity,
            'participant_name': name,
        }
    )
    return response.json()

# Usage
result = get_token('my-room', 'user123', 'John Doe')
token = result['token']
url = result['url']
```

## Development

### Available Tasks

```bash
task install  # Install dependencies
task dev      # Run development server with hot reload
task start    # Run production server
task test     # Test all endpoints
task clean    # Clean up generated files
```

### Testing

Test the endpoints using Task:

```bash
task test
```

Or manually using curl:

```bash
# Health check
curl http://localhost:8000/health

# Generate token
curl -X POST http://localhost:8000/livekit/token \
  -H "Content-Type: application/json" \
  -d '{
    "room_name": "test-room",
    "participant_identity": "test-user",
    "participant_name": "Test User"
  }'
```

## License

This project follows the same license as the parent repository.
